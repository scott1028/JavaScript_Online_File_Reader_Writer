<!doctype html>
<html lang="zh-TW">
<head>
	<meta charset="UTF-8">
	<title>SSD Wording XML Editor v0.1</title>
</head>
<body style="overflow-x: scroll; overflow-y: scroll">
	<input type="file" id="input_file" />
	<button id="downloadBtn">下載XML</button>
	<hr />
	<!-- Read -->
	<script>
		function xml_update_and_output(text){
			// XML Parser
			var dom_parser=new DOMParser();
			var xmlDoc=dom_parser.parseFromString(text,"text/xml");
			console.debug(xmlDoc);

			var wordings = xmlDoc.querySelectorAll('string[name]');
			console.debug(wordings);

			var xml_parser = new XMLSerializer();
			var xml_string = xml_parser.serializeToString(xmlDoc);
			return xml_string;
		};

		function readSingleFile(evt) {
			// 在使用者選擇檔案後立即讀取該檔案
			var f = evt.target.files[0]; 

			if (f) {
				var r = new FileReader();
				r.onload = function(e) { 
					var contents = e.target.result;
					try{
						console.log( "Got the file.n" 
							+"name: " + f.name + "n"
							+"type: " + f.type + "n"
							+"size: " + f.size + " bytesn"
							+ "starts with: " + contents.substr(1, contents.indexOf("n"))
						);
					}
					catch(e){
						console.log(e);
					}

					// 輸出
					console.log(contents);

					// XML Parser
					xml_update_and_output(contents);


					// 輸出
					var preview;
					if(!document.getElementById('result')){
						preview=document.createElement('pre');
						preview.id="result"
						preview.textContent=contents;
						preview.style.cssText = 'color: white; background-color: #303030; width: 90%; overflow-x: scroll; padding: 10px; margin: auto;';
						document.body.appendChild(preview);
					}
					else{
						preview=document.getElementById('result');
						preview.textContent=contents;
					}

					// debugger;
				}

				r.readAsText(f);					// 當作 Safe HTML String 讀取
				// r.readAsArrayBuffer(f);			// 也可以當作 ArrayBuffer 再轉 Blob 提供使用者下載
			}
			else {
				alert("Failed to load file");
			}
		};

		document.getElementById('input_file').addEventListener('change', readSingleFile, false);
	</script>

	<!-- Download -->
	<script>
		function downloadSingleFile(evt){
			var output=document.getElementById('result').textContent;
			var blob=new Blob([output],{type:'application/x-file-to-save'});			// 讓瀏覽器辨識為可下載的連結, 也可以用 "octet/stream"
			var url=window.URL.createObjectURL(blob);			// 要使用 Blob URL, 需要有 Domain Name

			var file_name;
			try{
				file_name = document.querySelector('[type=file]').files[0].name;
			}
			catch(e){
				file_name = 'test.xml';
			};

			// 不需要把這個元素加入 document
			var downloadURL=document.createElement('a');
			downloadURL.href=url;
			downloadURL.download=file_name;			// 指定下載檔名
			downloadURL.click();
		};

		document.getElementById('downloadBtn').addEventListener('click',downloadSingleFile, false);
	</script>
</body>
</html>